<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç®¡ç†</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body{margin:0;padding:0;overscroll-behavior:none}
.bounce{animation:b 1s infinite}
.pulse{animation:p 2s cubic-bezier(.4,0,.6,1) infinite}
@keyframes b{0%,100%{transform:translateY(-25%);animation-timing-function:cubic-bezier(.8,0,1,1)}50%{transform:translateY(0);animation-timing-function:cubic-bezier(0,0,.2,1)}}
@keyframes p{0%,100%{opacity:1}50%{opacity:.5}}
.grad-all{background:linear-gradient(135deg,#fb7185 0%,#34d399 50%,#fbbf24 100%);animation:shimmer 3s ease-in-out infinite}
.grad-up-low{background:linear-gradient(135deg,#fda4af 0%,#6ee7b7 100%)}
.grad-up-core{background:linear-gradient(135deg,#fda4af 0%,#fcd34d 100%)}
.grad-low-core{background:linear-gradient(135deg,#6ee7b7 0%,#fcd34d 100%)}
@keyframes shimmer{0%,100%{background-position:0% 50%}50%{background-position:100% 50%}}
.grad-all{background-size:200% 200%}
</style>
</head>
<body>
<div id="root"></div>
<script>
const defaultCats=[
  {id:'mon',name:'æœˆæ›œæ—¥',days:[1],color:'rose'},
  {id:'tue',name:'ç«æ›œæ—¥',days:[2],color:'orange'},
  {id:'wed',name:'æ°´æ›œæ—¥',days:[3],color:'amber'},
  {id:'thu',name:'æœ¨æ›œæ—¥',days:[4],color:'emerald'},
  {id:'fri',name:'é‡‘æ›œæ—¥',days:[5],color:'blue'},
  {id:'sat',name:'åœŸæ›œæ—¥',days:[6],color:'purple'}
];
const days=['æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ','æ—¥'];

let cats=JSON.parse(JSON.stringify(defaultCats));

const defaultSubs = {
  mon:[
    {name:'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°1',emoji:'ğŸ’ª',img:'',desc:'',sets:''},
    {name:'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°2',emoji:'ğŸ‹ï¸',img:'',desc:'',sets:''},
    {name:'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°3',emoji:'ğŸ¤¸',img:'',desc:'',sets:''},
    {name:'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°4',emoji:'ğŸ’ª',img:'',desc:'',sets:''}
  ],
  tue:[
    {name:'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°1',emoji:'ğŸ’ª',img:'',desc:'',sets:''},
    {name:'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°2',emoji:'ğŸ‹ï¸',img:'',desc:'',sets:''},
    {name:'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°3',emoji:'ğŸ¤¸',img:'',desc:'',sets:''},
    {name:'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°4',emoji:'ğŸ’ª',img:'',desc:'',sets:''}
  ],
  wed:[
    {name:'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°1',emoji:'ğŸ’ª',img:'',desc:'',sets:''},
    {name:'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°2',emoji:'ğŸ‹ï¸',img:'',desc:'',sets:''},
    {name:'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°3',emoji:'ğŸ¤¸',img:'',desc:'',sets:''},
    {name:'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°4',emoji:'ğŸ’ª',img:'',desc:'',sets:''}
  ],
  thu:[
    {name:'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°1',emoji:'ğŸ’ª',img:'',desc:'',sets:''},
    {name:'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°2',emoji:'ğŸ‹ï¸',img:'',desc:'',sets:''},
    {name:'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°3',emoji:'ğŸ¤¸',img:'',desc:'',sets:''},
    {name:'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°4',emoji:'ğŸ’ª',img:'',desc:'',sets:''}
  ],
  fri:[
    {name:'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°1',emoji:'ğŸ’ª',img:'',desc:'',sets:''},
    {name:'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°2',emoji:'ğŸ‹ï¸',img:'',desc:'',sets:''},
    {name:'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°3',emoji:'ğŸ¤¸',img:'',desc:'',sets:''},
    {name:'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°4',emoji:'ğŸ’ª',img:'',desc:'',sets:''}
  ],
  sat:[
    {name:'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°1',emoji:'ğŸ’ª',img:'',desc:'',sets:''},
    {name:'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°2',emoji:'ğŸ‹ï¸',img:'',desc:'',sets:''},
    {name:'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°3',emoji:'ğŸ¤¸',img:'',desc:'',sets:''},
    {name:'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°4',emoji:'ğŸ’ª',img:'',desc:'',sets:''}
  ]
};

let st={
  view:'weekly',
  subs:JSON.parse(JSON.stringify(defaultSubs)),
  prog:{mon:{c:false,s:[0,0,0,0]},tue:{c:false,s:[0,0,0,0]},wed:{c:false,s:[0,0,0,0]},thu:{c:false,s:[0,0,0,0]},fri:{c:false,s:[0,0,0,0]},sat:{c:false,s:[0,0,0,0]}},
  exp:{mon:1,tue:1,wed:1,thu:1,fri:1,sat:1},
  hist:{},
  streak:0,
  celeb:0,
  week:'',
  ed:null,
  ei:null,
  calMon:new Date().getMonth(),
  calYear:new Date().getFullYear(),
  showUrlModal:false,
  generatedUrl:'',
  isSharedConfig:false,
  editingCat:null,
  title:'ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ç®¡ç†',
  subtitle:'é€±é–“ç›®æ¨™é”æˆã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†',
  editingTitle:false
};

function getWk(d=new Date()){
  const t=new Date(d),day=t.getDay(),diff=t.getDate()-day+(day===0?-6:1);
  t.setDate(diff);t.setHours(0,0,0,0);
  return t.toISOString().split('T')[0];
}

function wk(d){return'w_'+getWk(d)}

function msg(w){
  if(w>=100&&w%100===0)return'100é€±é€£ç¶šé”æˆ!é©šç•°çš„ãªç¶™ç¶šåŠ›!ç¿’æ…£ã‚’ç©ã¿é‡ã­ã¦ããŸã‚ãªãŸã¯æœ¬å½“ã«ç´ æ™´ã‚‰ã—ã„ã§ã™!';
  const m={
    10:'10é€±é€£ç¶šé”æˆ!ç´ æ™´ã‚‰ã—ã„ç¶™ç¶šåŠ›ã§ã™!ç¿’æ…£åŒ–ã¸ã®ç¬¬ä¸€æ­©ã§ã™ã­',
    20:'20é€±é€£ç¶šé”æˆ!ã‚‚ã†ç«‹æ´¾ãªç¿’æ…£ã«ãªã£ã¦ã„ã¾ã™!å¤‰åŒ–ã‚’æ„Ÿã˜ã¦ã„ã¾ã›ã‚“ã‹?',
    30:'30é€±é€£ç¶šé”æˆ!åŠå¹´ä»¥ä¸Šã®ç¶™ç¶šã€æœ¬å½“ã«ç´ æ™´ã‚‰ã—ã„ã§ã™!',
    40:'40é€±é€£ç¶šé”æˆ!ã‚ãªãŸã®åŠªåŠ›ãŒè¼ã„ã¦ã„ã¾ã™!å‘¨ã‚Šã‚‚æ°—ã¥ã„ã¦ã„ã‚‹ã¯ãš',
    50:'50é€±é€£ç¶šé”æˆ!1å¹´è¿‘ãç¶šã‘ã‚‰ã‚Œã‚‹ãªã‚“ã¦é©šç•°çš„!è‡ªä¿¡ã‚’æŒã£ã¦ãã ã•ã„',
    60:'60é€±é€£ç¶šé”æˆ!ã‚‚ã†ç”Ÿæ´»ã®ä¸€éƒ¨ã§ã™ã­!ã“ã®èª¿å­ã§ç¶šã‘ã¾ã—ã‚‡ã†',
    70:'70é€±é€£ç¶šé”æˆ!ä¸¦å¤–ã‚ŒãŸç¶™ç¶šåŠ›!ã‚ãªãŸã¯æœ¬å½“ã«å¼·ã„æ–¹ã§ã™',
    80:'80é€±é€£ç¶šé”æˆ!ã‚‚ã†ã™ã2å¹´!ç´ æ™´ã‚‰ã—ã„ç¿’æ…£ãŒèº«ã«ã¤ã„ã¦ã„ã¾ã™',
    90:'90é€±é€£ç¶šé”æˆ!100é€±ã¾ã§ã‚ã¨å°‘ã—!ã“ã“ã¾ã§æ¥ãŸã‚ãªãŸã¯æœ€é«˜ã§ã™'
  };
  return m[w]||w+'é€±é€£ç¶šé”æˆ!ç´ æ™´ã‚‰ã—ã„ç¶™ç¶šåŠ›ã§ã™!';
}

function snd(t){
  try{
    const a=new(window.AudioContext||window.webkitAudioContext)(),n=a.currentTime;
    if(t==='h'){
      const f=[523,659,784,1047,784,659,523,659,784,1047,1175,1319,1568],d=[.15,.15,.15,.3,.15,.15,.15,.15,.15,.3,.3,.3,.6];
      let c=n;
      f.forEach((q,i)=>{const o=a.createOscillator(),g=a.createGain();o.connect(g);g.connect(a.destination);o.frequency.value=q;g.gain.setValueAtTime(.3,c);g.gain.exponentialRampToValueAtTime(.01,c+d[i]);o.start(c);o.stop(c+d[i]);c+=d[i]});
    }else if(t==='t'){
      const f=[523,659,784,1047,1175],d=[.2,.2,.2,.3,.4];
      let c=n;
      f.forEach((q,i)=>{const o=a.createOscillator(),g=a.createGain();o.connect(g);g.connect(a.destination);o.frequency.value=q;o.type='triangle';g.gain.setValueAtTime(.2,c);g.gain.exponentialRampToValueAtTime(.01,c+d[i]);o.start(c);o.stop(c+d[i]);c+=d[i]});
    }else{
      [523,659,784].forEach((q,i)=>{const o=a.createOscillator(),g=a.createGain();o.connect(g);g.connect(a.destination);o.frequency.value=q;const s=n+(i*.1);g.gain.setValueAtTime(.15,s);g.gain.exponentialRampToValueAtTime(.01,s+.3);o.start(s);o.stop(s+.3)});
    }
  }catch(e){}
}

function score(p){
  let totalItems=0;
  let completedItems=0;
  cats.forEach(c=>{
    const itemCount=st.subs[c.id]?.length||0;
    totalItems+=itemCount;
    if(p[c.id]?.c){
      completedItems+=itemCount;
    }else{
      completedItems+=(p[c.id]?.s||[]).filter(Boolean).length;
    }
  });
  return totalItems===0?0:Math.round((completedItems/totalItems)*100);
}

function streak(h,cw,cs=0){
  let cnt=cs===100?1:0,d=new Date(cw);
  while(1){
    d.setDate(d.getDate()-7);
    const k=wk(d);
    if(h[k]&&h[k].sc===100)cnt++;else break;
  }
  st.streak=cnt;
}

function save(p){
  const k=wk(new Date());
  localStorage.setItem(k,JSON.stringify(p));
  const sc=score(p),h={...st.hist};
  h[k]={sc,c:sc===100,dt:st.week};
  localStorage.setItem('th',JSON.stringify(h));
  st.hist=h;
  streak(h,st.week,sc);
  if(sc===100&&!st.celeb){
    const n=st.streak;
    let tp='n';
    if(n%100===0){st.celeb='h';tp='h'}
    else if(n%10===0){st.celeb='t';tp='t'}
    else st.celeb='n';
    snd(tp);
    setTimeout(()=>{st.celeb=0;render()},5000);
  }
  render();
}

function loadFromUrl(){
  try{
    const hash=window.location.hash.substring(1);
    if(hash){
      const decoded=decodeURIComponent(escape(atob(hash)));
      const config=JSON.parse(decoded);
      if(config.subs){
        st.subs=config.subs;
        st.isSharedConfig=true;
        // å…±æœ‰è¨­å®šã®å ´åˆã€åˆå›ã®ã¿localStorageã«ä¿å­˜
        const savedConfig=localStorage.getItem('sc');
        if(!savedConfig){
          localStorage.setItem('sc',JSON.stringify(config.subs));
        }
      }
      if(config.cats){
        cats=config.cats;
        st.isSharedConfig=true;
        const savedCats=localStorage.getItem('cats');
        if(!savedCats){
          localStorage.setItem('cats',JSON.stringify(config.cats));
        }
      }
      if(config.title){
        st.title=config.title;
        st.subtitle=config.subtitle||'é€±é–“ç›®æ¨™é”æˆã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†';
        st.isSharedConfig=true;
        const savedTitle=localStorage.getItem('title');
        if(!savedTitle){
          localStorage.setItem('title',st.title);
          localStorage.setItem('subtitle',st.subtitle);
        }
      }
    }
  }catch(e){
    console.error('URLèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:',e);
  }
}

function editCat(id){
  st.editingCat=id;
  render();
}

function saveCat(id,name,day1,day2){
  const idx=cats.findIndex(c=>c.id===id);
  if(idx!==-1){
    cats[idx].name=name;
    cats[idx].days=[parseInt(day1)];
    localStorage.setItem('cats',JSON.stringify(cats));
  }
  st.editingCat=null;
  render();
}

function editTitle(){
  st.editingTitle=true;
  render();
}

function saveTitle(title,subtitle){
  st.title=title;
  st.subtitle=subtitle;
  localStorage.setItem('title',title);
  localStorage.setItem('subtitle',subtitle);
  st.editingTitle=false;
  render();
}

function addCategory(){
  const newId='cat_'+Date.now();
  const colors=['rose','orange','amber','emerald','blue','purple','pink','indigo'];
  const randomColor=colors[cats.length%colors.length];
  cats.push({id:newId,name:'æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªãƒ¼',days:[1],color:randomColor});
  st.subs[newId]=[
    {name:'é …ç›®1',emoji:'ğŸ’ª',img:'',desc:'',sets:''},
    {name:'é …ç›®2',emoji:'ğŸ’ª',img:'',desc:'',sets:''}
  ];
  st.prog[newId]={c:false,s:[0,0]};
  st.exp[newId]=1;
  localStorage.setItem('cats',JSON.stringify(cats));
  localStorage.setItem('sc',JSON.stringify(st.subs));
  render();
}

function deleteCategory(id){
  if(!confirm('ã“ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;
  const idx=cats.findIndex(c=>c.id===id);
  if(idx!==-1){
    cats.splice(idx,1);
    delete st.subs[id];
    delete st.prog[id];
    delete st.exp[id];
    localStorage.setItem('cats',JSON.stringify(cats));
    localStorage.setItem('sc',JSON.stringify(st.subs));
    render();
  }
}

function moveCategoryUp(id){
  const idx=cats.findIndex(c=>c.id===id);
  if(idx>0){
    [cats[idx-1],cats[idx]]=[cats[idx],cats[idx-1]];
    localStorage.setItem('cats',JSON.stringify(cats));
    render();
  }
}

function moveCategoryDown(id){
  const idx=cats.findIndex(c=>c.id===id);
  if(idx<cats.length-1){
    [cats[idx],cats[idx+1]]=[cats[idx+1],cats[idx]];
    localStorage.setItem('cats',JSON.stringify(cats));
    render();
  }
}

function moveSubItemUp(catId,idx){
  if(idx>0){
    [st.subs[catId][idx-1],st.subs[catId][idx]]=[st.subs[catId][idx],st.subs[catId][idx-1]];
    [st.prog[catId].s[idx-1],st.prog[catId].s[idx]]=[st.prog[catId].s[idx],st.prog[catId].s[idx-1]];
    localStorage.setItem('sc',JSON.stringify(st.subs));
    render();
  }
}

function moveSubItemDown(catId,idx){
  if(idx<st.subs[catId].length-1){
    [st.subs[catId][idx],st.subs[catId][idx+1]]=[st.subs[catId][idx+1],st.subs[catId][idx]];
    [st.prog[catId].s[idx],st.prog[catId].s[idx+1]]=[st.prog[catId].s[idx+1],st.prog[catId].s[idx]];
    localStorage.setItem('sc',JSON.stringify(st.subs));
    render();
  }
}

function addSubItem(catId){
  if(!st.subs[catId])st.subs[catId]=[];
  st.subs[catId].push({name:'æ–°ã—ã„é …ç›®',emoji:'ğŸ’ª',img:'',desc:'',sets:''});
  if(!st.prog[catId])st.prog[catId]={c:false,s:[]};
  st.prog[catId].s.push(0);
  localStorage.setItem('sc',JSON.stringify(st.subs));
  render();
}

function deleteSubItem(catId,idx){
  if(!confirm('ã“ã®é …ç›®ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;
  st.subs[catId].splice(idx,1);
  st.prog[catId].s.splice(idx,1);
  localStorage.setItem('sc',JSON.stringify(st.subs));
  render();
}

function load(){
  const ws=getWk();st.week=ws;
  const k=wk(new Date()),lw=localStorage.getItem('lw');
  if(lw&&lw!==ws){
    st.prog={mon:{c:false,s:[0,0,0,0]},tue:{c:false,s:[0,0,0,0]},wed:{c:false,s:[0,0,0,0]},thu:{c:false,s:[0,0,0,0]},fri:{c:false,s:[0,0,0,0]},sat:{c:false,s:[0,0,0,0]}};
    localStorage.setItem(k,JSON.stringify(st.prog));
  }
  localStorage.setItem('lw',ws);
  
  // URLè¨­å®šã‚’æœ€åˆã«èª­ã¿è¾¼ã‚€
  loadFromUrl();
  
  // localStorageã‹ã‚‰ã‚¿ã‚¤ãƒˆãƒ«è¨­å®šã‚’èª­ã¿è¾¼ã‚€
  const savedTitle=localStorage.getItem('title');
  const savedSubtitle=localStorage.getItem('subtitle');
  if(savedTitle && !st.isSharedConfig){
    st.title=savedTitle;
    st.subtitle=savedSubtitle||'é€±é–“ç›®æ¨™é”æˆã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†';
  }
  
  // localStorageã‹ã‚‰ã‚«ãƒ†ã‚´ãƒªè¨­å®šã‚’èª­ã¿è¾¼ã‚€ï¼ˆURLè¨­å®šãŒãªã„å ´åˆã®ã¿ä¸Šæ›¸ãï¼‰
  const savedCats=localStorage.getItem('cats');
  if(savedCats && !st.isSharedConfig){
    cats=JSON.parse(savedCats);
  }
  
  // localStorageã‹ã‚‰è¨­å®šã‚’èª­ã¿è¾¼ã‚€ï¼ˆURLè¨­å®šãŒãªã„å ´åˆã®ã¿ä¸Šæ›¸ãï¼‰
  const ss=localStorage.getItem('sc');
  if(ss && !st.isSharedConfig){
    st.subs=JSON.parse(ss);
  }
  
  const sp=localStorage.getItem(k);
  if(sp)st.prog=JSON.parse(sp);
  const sh=localStorage.getItem('th');
  if(sh){st.hist=JSON.parse(sh);streak(st.hist,ws,sp?score(JSON.parse(sp)):0)}
}

function tMain(i){
  const c=!st.prog[i].c;
  st.prog[i]={c,s:c?[1,1,1,1]:[0,0,0,0]};
  save(st.prog);
}

function tSub(i,j){
  st.prog[i].s[j]=!st.prog[i].s[j];
  if(st.prog[i].c)st.prog[i].c=false;
  save(st.prog);
}

function edit(i,j){st.ed=i;st.ei=j;render()}

function saveE(i,j,n,e,u,s,d){
  st.subs[i][j]={name:n,emoji:e,img:u,sets:s,desc:d};
  localStorage.setItem('sc',JSON.stringify(st.subs));
  st.ed=null;st.ei=null;render();
}

function generateShareUrl(){
  const config={subs:st.subs,cats:cats,title:st.title,subtitle:st.subtitle};
  const encoded=btoa(unescape(encodeURIComponent(JSON.stringify(config))));
  const url=window.location.origin+window.location.pathname+'#'+encoded;
  st.generatedUrl=url;
  st.showUrlModal=true;
  render();
}

function copyUrl(){
  const textarea=document.getElementById('urlTextarea');
  textarea.select();
  textarea.setSelectionRange(0,99999);
  navigator.clipboard.writeText(st.generatedUrl).then(()=>{
    alert('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ã“ã®URLã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚');
  }).catch(()=>{
    alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§URLã‚’é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚');
  });
}

function closeModal(){
  st.showUrlModal=false;
  render();
}

function getDays(y,m){
  const fd=new Date(y,m,1),ld=new Date(y,m+1,0),sd=fd.getDay(),ed=ld.getDate(),arr=[];
  for(let i=0;i<(sd===0?6:sd-1);i++)arr.push(null);
  for(let i=1;i<=ed;i++)arr.push(i);
  return arr;
}

function getDayStatus(y,m,d){
  const dt=new Date(y,m,d),ws=getWk(dt),k=wk(dt);
  const p=localStorage.getItem(k);
  if(!p)return{score:0};
  const pr=JSON.parse(p);
  const sc=score(pr);
  const dw=dt.getDay()||7;
  const status={score:sc};
  cats.forEach(c=>{
    if(c.days.includes(dw)){
      if(pr[c.id]?.c)status[c.id]=true;
      else if(pr[c.id]?.s?.some(Boolean))status[c.id]='partial';
    }
  });
  return status;
}

function render(){
  const sc=score(st.prog),cd=getDays(st.calYear,st.calMon);
  document.getElementById('root').innerHTML=`
    <div class="min-h-screen p-4 md:p-8">
      <div class="max-w-4xl mx-auto">
        <div class="text-center mb-8">
          ${st.editingTitle?`
            <div class="max-w-2xl mx-auto space-y-3">
              <input type="text" value="${st.title}" placeholder="ã‚¿ã‚¤ãƒˆãƒ«" class="w-full bg-white text-stone-800 px-4 py-2 rounded-lg border border-stone-200 text-3xl font-bold text-center" id="titleInput">
              <input type="text" value="${st.subtitle}" placeholder="ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ«" class="w-full bg-white text-stone-600 px-4 py-2 rounded-lg border border-stone-200 text-center" id="subtitleInput">
              <button onclick="saveTitle(document.getElementById('titleInput').value,document.getElementById('subtitleInput').value)" class="bg-rose-400 hover:bg-rose-500 text-white px-6 py-2 rounded-lg font-medium">ä¿å­˜</button>
            </div>
          `:`
            <div class="inline-flex items-center gap-3">
              <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-rose-600 to-amber-600 bg-clip-text text-transparent">${st.title}</h1>
              <button onclick="editTitle()" class="text-stone-400 hover:text-stone-600 mb-2">âœï¸</button>
            </div>
            <p class="text-stone-600">${st.subtitle}</p>
          `}
          ${st.isSharedConfig?'<p class="text-xs text-green-600 mt-1">âœ“ ã‚«ã‚¹ã‚¿ãƒ è¨­å®šãŒé©ç”¨ã•ã‚Œã¦ã„ã¾ã™</p>':''}
        </div>
        
        
        <div class="mb-4 text-center">
          <button onclick="generateShareUrl()" class="bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white px-6 py-3 rounded-xl shadow-lg transition-all font-bold">
            ğŸ“¤ å€‹äººç”¨URLã‚’ç”Ÿæˆ
          </button>
        </div>
        
        
        <div class="flex gap-2 mb-6 bg-white/80 backdrop-blur p-1 rounded-xl shadow-sm">
          <button onclick="st.view='weekly';render()" class="flex-1 py-3 px-4 rounded-lg transition-all font-medium ${st.view==='weekly'?'bg-rose-400 text-white shadow-md':'text-stone-600'}">ä»Šé€±</button>
          <button onclick="st.view='calendar';render()" class="flex-1 py-3 px-4 rounded-lg transition-all font-medium ${st.view==='calendar'?'bg-rose-400 text-white shadow-md':'text-stone-600'}">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</button>
          <button onclick="st.view='history';render()" class="flex-1 py-3 px-4 rounded-lg transition-all font-medium ${st.view==='history'?'bg-rose-400 text-white shadow-md':'text-stone-600'}">å±¥æ­´</button>
        </div>
        
        ${st.view==='weekly'?`
          <div class="bg-white/80 backdrop-blur rounded-2xl p-8 mb-6 shadow-lg">
            <div class="text-center">
              <div class="text-6xl font-bold mb-3 text-stone-800">${sc}<span class="text-3xl text-stone-500">%</span></div>
              <div class="w-full bg-stone-200 rounded-full h-3 mb-4">
                <div class="bg-gradient-to-r from-rose-400 to-amber-400 h-3 rounded-full transition-all duration-500" style="width:${sc}%"></div>
              </div>
              ${sc===100?'<div class="text-amber-600 pulse font-bold text-lg">ğŸ† ç´ æ™´ã‚‰ã—ã„ã§ã™! ğŸ†</div>':''}
              ${st.streak>0?`<div class="mt-3 text-lg font-semibold text-rose-600">âœ¨ ${st.streak}é€±é€£ç¶šé”æˆä¸­!</div>`:''}
            </div>
          </div>
          ${st.celeb?celeb():''}
          ${cats.map(c=>`
            <div class="bg-white/80 backdrop-blur rounded-2xl p-5 mb-4 shadow-md">
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-4 flex-1">
                  <button onclick="tMain('${c.id}')" class="w-9 h-9 rounded-xl border-2 flex items-center justify-center transition-all flex-shrink-0 ${st.prog[c.id]?.c?`bg-${c.color}-400 border-transparent shadow-md text-white`:'border-stone-300 bg-white'}">
                    ${st.prog[c.id]?.c?'âœ“':''}
                  </button>
                  <div class="flex-1">
                    ${st.editingCat===c.id?`
                      <div class="flex gap-2 items-center">
                        <input type="text" value="${c.name}" placeholder="ã‚«ãƒ†ã‚´ãƒªå" class="bg-white text-stone-800 px-3 py-1 rounded-lg border border-stone-200 text-lg font-bold" id="catName_${c.id}">
                        <select class="bg-white text-stone-800 px-2 py-1 rounded-lg border border-stone-200 text-sm" id="catDay1_${c.id}">
                          ${days.map((d,i)=>`<option value="${i+1}" ${c.days[0]===i+1?'selected':''}>${d}</option>`).join('')}
                        </select>
                        <button onclick="saveCat('${c.id}',document.getElementById('catName_${c.id}').value,document.getElementById('catDay1_${c.id}').value,document.getElementById('catDay1_${c.id}').value)" class="bg-rose-400 hover:bg-rose-500 text-white px-3 py-1 rounded-lg text-sm font-medium">ä¿å­˜</button>
                      </div>
                    `:`
                      <h3 class="text-xl font-bold text-stone-800">${c.name}</h3>
                      <p class="text-sm text-stone-500">${days[c.days[0]-1]}</p>
                    `}
                  </div>
                  ${st.editingCat!==c.id?`
                    <div class="flex gap-1">
                      ${cats.indexOf(c)>0?`<button onclick="moveCategoryUp('${c.id}')" class="text-stone-400 hover:text-stone-600 p-1" title="ä¸Šã¸ç§»å‹•">â–²</button>`:''}
                      ${cats.indexOf(c)<cats.length-1?`<button onclick="moveCategoryDown('${c.id}')" class="text-stone-400 hover:text-stone-600 p-1" title="ä¸‹ã¸ç§»å‹•">â–¼</button>`:''}
                      <button onclick="editCat('${c.id}')" class="text-stone-400 hover:text-stone-600 p-1">âœï¸</button>
                      ${cats.length>1?`<button onclick="deleteCategory('${c.id}')" class="text-red-400 hover:text-red-600 p-1">ğŸ—‘ï¸</button>`:''}
                    </div>
                  `:''}
                </div>
                <button onclick="st.exp['${c.id}']=!st.exp['${c.id}'];render()" class="ml-2 text-stone-400">
                  ${st.exp[c.id]?'â–²':'â–¼'}
                </button>
              </div>
              ${st.exp[c.id]?`
                <div class="mt-4 space-y-3 pl-13">
                  ${st.subs[c.id].map((s,i)=>`
                    <div class="bg-stone-50/80 rounded-xl p-4 border border-stone-200">
                      <div class="flex items-start gap-3">
                        <button onclick="tSub('${c.id}',${i})" class="w-6 h-6 mt-1 rounded-lg border-2 flex items-center justify-center transition-all flex-shrink-0 ${st.prog[c.id]?.s[i]?'bg-stone-400 border-transparent text-white':'border-stone-300 bg-white'}">
                          ${st.prog[c.id]?.s[i]?'âœ“':''}
                        </button>
                        <div class="w-16 h-16 flex-shrink-0 bg-gradient-to-br from-rose-100 to-amber-100 rounded-xl flex items-center justify-center text-4xl">${s.emoji||'ğŸ’ª'}</div>
                        ${st.ed===c.id&&st.ei===i?`
                          <div class="flex-1 space-y-3">
                            <input type="text" value="${s.name}" placeholder="åå‰" class="w-full bg-white text-stone-800 px-3 py-2 rounded-lg border border-stone-200" id="n${i}">
                            <input type="text" value="${s.emoji}" placeholder="çµµæ–‡å­—" class="w-full bg-white text-stone-800 px-3 py-2 rounded-lg border border-stone-200 text-sm" id="e${i}">
                            <input type="text" value="${s.img}" placeholder="ç”»åƒURL" class="w-full bg-white text-stone-800 px-3 py-2 rounded-lg border border-stone-200 text-sm" id="u${i}">
                            <input type="text" value="${s.sets}" placeholder="ã‚»ãƒƒãƒˆæ•°" class="w-full bg-white text-stone-800 px-3 py-2 rounded-lg border border-stone-200 text-sm" id="s${i}">
                            <textarea placeholder="è©³ç´°" class="w-full bg-white text-stone-800 px-3 py-2 rounded-lg border border-stone-200 text-sm resize-none" rows="3" id="d${i}">${s.desc}</textarea>
                            <button onclick="saveE('${c.id}',${i},document.getElementById('n${i}').value,document.getElementById('e${i}').value,document.getElementById('u${i}').value,document.getElementById('s${i}').value,document.getElementById('d${i}').value)" class="w-full bg-rose-400 hover:bg-rose-500 text-white px-4 py-2 rounded-lg transition-colors font-medium shadow-sm">ä¿å­˜</button>
                          </div>
                        `:`
                          <div class="flex-1 min-w-0">
                            <div class="text-base font-semibold mb-1 text-stone-800">${s.name}</div>
                            ${s.sets?`<div class="text-sm text-rose-600 font-medium mb-2">ğŸ“ ${s.sets}</div>`:''}
                            ${s.desc?`<div class="text-sm text-stone-600 whitespace-pre-wrap leading-relaxed mb-2">${s.desc}</div>`:''}
                            ${s.img?`<a href="${s.img}" target="_blank" class="inline-flex items-center gap-1 text-xs text-blue-600 hover:underline">ğŸ”— å‚è€ƒç”»åƒ</a>`:''}
                            ${!s.desc&&!s.sets&&!s.img?'<div class="text-sm text-stone-400 italic">è©³ç´°æœªè¨­å®š</div>':''}
                          </div>
                          <div class="flex flex-col gap-1">
                            ${i>0?`<button onclick="moveSubItemUp('${c.id}',${i})" class="text-stone-400 hover:text-stone-600 text-xs" title="ä¸Šã¸ç§»å‹•">â–²</button>`:'<div class="h-4"></div>'}
                            ${i<st.subs[c.id].length-1?`<button onclick="moveSubItemDown('${c.id}',${i})" class="text-stone-400 hover:text-stone-600 text-xs" title="ä¸‹ã¸ç§»å‹•">â–¼</button>`:'<div class="h-4"></div>'}
                          </div>
                          <button onclick="edit('${c.id}',${i})" class="text-stone-400 hover:text-stone-600 p-1">âœï¸</button>
                          ${st.subs[c.id].length>1?`<button onclick="deleteSubItem('${c.id}',${i})" class="text-red-400 hover:text-red-600 p-1">ğŸ—‘ï¸</button>`:''}
                        `}
                      </div>
                    </div>
                  `).join('')}
                  <button onclick="addSubItem('${c.id}')" class="w-full bg-green-100 hover:bg-green-200 text-green-700 px-4 py-3 rounded-xl transition-colors font-medium border-2 border-dashed border-green-300">
                    â• é …ç›®ã‚’è¿½åŠ 
                  </button>
                </div>
              `:''}
            </div>
          `).join('')}
          
          <div class="text-center mt-6">
            <button onclick="addCategory()" class="bg-gradient-to-r from-green-500 to-teal-500 hover:from-green-600 hover:to-teal-600 text-white px-6 py-3 rounded-xl shadow-lg transition-all font-bold">
              â• ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’è¿½åŠ 
            </button>
          </div>
        `:st.view==='calendar'?`
          <div class="bg-white/80 backdrop-blur rounded-2xl p-6 shadow-lg">
            <div class="flex items-center justify-between mb-6">
              <button onclick="st.calMon--;if(st.calMon<0){st.calMon=11;st.calYear--}render()" class="text-stone-600 hover:text-stone-800 px-3 py-1">â—€</button>
              <h2 class="text-2xl font-bold text-stone-800">${st.calYear}å¹´${st.calMon+1}æœˆ</h2>
              <button onclick="st.calMon++;if(st.calMon>11){st.calMon=0;st.calYear++}render()" class="text-stone-600 hover:text-stone-800 px-3 py-1">â–¶</button>
            </div>
            <div class="grid grid-cols-7 gap-2">
              ${['æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ','æ—¥'].map(d=>`<div class="text-center text-sm font-semibold text-stone-600 py-2">${d}</div>`).join('')}
              ${cd.map(d=>{
                if(!d)return'<div></div>';
                const ds=getDayStatus(st.calYear,st.calMon,d);
                const perfectScore=ds.score===100;
                let cls='bg-stone-100 text-stone-700';
                
                if(perfectScore){
                  cls='grad-all text-white font-bold shadow-md';
                }else if(ds.score>0){
                  cls='bg-gradient-to-br from-rose-200 to-purple-200 text-stone-800';
                }
                return`<div class="aspect-square flex items-center justify-center rounded-lg ${cls} text-sm transition-all">${d}</div>`;
              }).join('')}
            </div>
            <div class="mt-6 text-sm text-stone-600 space-y-1">
              <div class="flex items-center gap-2"><div class="w-4 h-4 rounded bg-gradient-to-r from-rose-400 to-purple-400"></div>ä¸€éƒ¨å®Œäº†</div>
              <div class="flex items-center gap-2"><div class="w-4 h-4 rounded grad-all"></div>å…¨ã¦å®Œäº†(100ç‚¹)ğŸ†</div>
            </div>
          </div>
        `:`
          <div class="bg-white/80 backdrop-blur rounded-2xl p-6 shadow-lg">
            <h2 class="text-2xl font-bold mb-6 text-stone-800">é”æˆå±¥æ­´</h2>
            <div class="space-y-3">
              ${Object.entries(st.hist).sort((a,b)=>b[1].dt.localeCompare(a[1].dt)).slice(0,12).map(([k,d])=>`
                <div class="flex items-center justify-between bg-stone-50 rounded-xl p-5 border border-stone-200">
                  <div class="flex items-center gap-4">
                    ${d.c?'ğŸ†':''}
                    <div>
                      <div class="font-semibold text-stone-800">${d.dt} ã®é€±</div>
                      <div class="text-sm text-stone-500">${new Date(d.dt).toLocaleDateString('ja-JP',{month:'long',day:'numeric'})}ã€œ</div>
                    </div>
                  </div>
                  <div class="text-2xl font-bold text-stone-800">${d.sc}<span class="text-sm text-stone-500">%</span></div>
                </div>
              `).join('')}
              ${Object.keys(st.hist).length===0?'<div class="text-center text-stone-400 py-12">ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>':''}
            </div>
          </div>
        `}
      </div>
    </div>
    
    ${st.showUrlModal?`
      <div class="fixed inset-0 bg-black/70 flex items-center justify-center p-4 z-50" onclick="closeModal()">
        <div class="bg-white rounded-2xl p-8 max-w-2xl w-full shadow-2xl" onclick="event.stopPropagation()">
          <h2 class="text-2xl font-bold mb-4 text-stone-800">å€‹äººç”¨URLã‚’ç”Ÿæˆã—ã¾ã—ãŸ</h2>
          <p class="text-stone-600 mb-4">ã“ã®URLã‚’å…±æœ‰ã—ã¦ãã ã•ã„ã€‚URLã‚’é–‹ãã¨ã€ç¾åœ¨ã®è¨­å®šãŒè‡ªå‹•çš„ã«åæ˜ ã•ã‚Œã¾ã™ã€‚</p>
          <div class="bg-blue-50 p-4 rounded-lg mb-4 border-2 border-blue-300">
            <textarea readonly class="w-full text-sm text-stone-800 break-all font-mono bg-transparent border-none outline-none resize-none" rows="4" id="urlTextarea">${st.generatedUrl}</textarea>
          </div>
          <div class="flex gap-3">
            <button onclick="copyUrl()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-bold transition-colors">
              ğŸ“‹ URLã‚’ã‚³ãƒ”ãƒ¼
            </button>
            <button onclick="closeModal()" class="flex-1 bg-stone-200 hover:bg-stone-300 text-stone-800 px-6 py-3 rounded-lg font-bold transition-colors">
              é–‰ã˜ã‚‹
            </button>
          </div>
        </div>
      </div>
    `:''}
  `;
}

function celeb(){
  if(st.celeb==='h'){
    return`<div class="fixed inset-0 z-50 pointer-events-none overflow-hidden">
      <div class="absolute inset-0 bg-gradient-to-br from-red-200 via-yellow-200 via-green-200 via-blue-200 to-purple-200 opacity-30 pulse"></div>
      <div class="absolute inset-0 flex flex-col items-center justify-center">
        <div class="text-9xl mb-6 bounce">ğŸ†</div>
        <div class="bg-white/95 backdrop-blur rounded-3xl p-8 shadow-2xl max-w-2xl mx-4 text-center border-4 border-amber-400">
          <div class="text-3xl font-bold text-amber-600 mb-4">${st.streak}é€±é€£ç¶šé”æˆ!</div>
          <div class="text-xl text-stone-700 leading-relaxed">${msg(st.streak)}</div>
          <div class="mt-6 flex justify-center gap-3 text-5xl">ğŸ’ğŸŒŸğŸ’–</div>
        </div>
      </div>
    </div>`;
  }else if(st.celeb==='t'){
    return`<div class="fixed inset-0 z-50 pointer-events-none overflow-hidden">
      <div class="absolute inset-0 flex flex-col items-center justify-center">
        <div class="text-8xl mb-6 bounce">ğŸ¥ˆ</div>
        <div class="bg-white/95 backdrop-blur rounded-2xl p-6 shadow-xl max-w-xl mx-4 text-center border-2 border-stone-300">
          <div class="text-2xl font-bold text-stone-700 mb-3">${st.streak}é€±é€£ç¶šé”æˆ!</div>
          <div class="text-lg text-stone-600">${msg(st.streak)}</div>
          <div class="mt-4 flex justify-center gap-2 text-3xl">ğŸŒŸğŸ’«âœ¨</div>
        </div>
      </div>
    </div>`;
  }else{
    return`<div class="fixed inset-0 z-50 pointer-events-none flex items-center justify-center">
      <div class="text-8xl bounce">ğŸŠ</div>
    </div>`;
  }
}

load();
render();
</script>
</body>
</html>
